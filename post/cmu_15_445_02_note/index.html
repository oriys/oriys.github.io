<!doctype html><html lang=en-us>
<head>
<link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title> CMU::15-445/645::Advanced SQL 笔记 | Y.CH.Y</title>
<link rel=canonical href=/post/cmu_15_445_02_note/>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta property="og:title" content="CMU::15-445/645::Advanced SQL 笔记">
<meta property="og:description" content="高级 SQL 关系语言 Edgar Codd 在 20 世纪 70 年代初发表了关于关系模型的主要论文。他最初只定义了 DBMS 如何在关系模型 DBMS 上执行查询的数学符号。
用户只需要使用声明性语言（即 SQL）来指定他们想要的结果。DBMS 负责通过使用查询优化器重新组合操作确定产生该答案的最有效计划。
关系代数是基于 sets（无序的，没有重复的）。SQL 是基于 bags（无序的，允许重复）
SQL 历史 SQL。结构化查询语言
IBM 最初称其为 SEQUEL (Structured English Query Language)
由不同类别的命令组成。
 数据操作语言（DML）。SELECT,INSERT,UPDATE,DELETE 数据定义语言（DDL）。模式定义。 数据控制语言（DCL）。安全，访问控制。  目前的 SQL 标准是 SQL:2016
各阶段引入的特性
 SQL:2016 → JSON, Polymorphic tables SQL:2011 → Temporal DBs, Pipelined DML SQL:2008 → TRUNCATE, Fancy sorting SQL:2003 → XML, windows, sequences, auto-gen IDs. SQL:1999 → Regex, triggers, OO  SQL 并没有死。它每隔几年就会有新的功能被更新。SQL-92 是一个 DBMS 必须支持的最低版本，以便声称他们支持 SQL。每个供应商都在一定程度上遵循该标准，但也有许多专有的扩展。">
<meta property="og:type" content="article">
<meta property="og:url" content="/post/cmu_15_445_02_note/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-08-01T09:07:42+08:00">
<meta property="article:modified_time" content="2021-08-01T09:07:42+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="CMU::15-445/645::Advanced SQL 笔记">
<meta name=twitter:description content="高级 SQL 关系语言 Edgar Codd 在 20 世纪 70 年代初发表了关于关系模型的主要论文。他最初只定义了 DBMS 如何在关系模型 DBMS 上执行查询的数学符号。
用户只需要使用声明性语言（即 SQL）来指定他们想要的结果。DBMS 负责通过使用查询优化器重新组合操作确定产生该答案的最有效计划。
关系代数是基于 sets（无序的，没有重复的）。SQL 是基于 bags（无序的，允许重复）
SQL 历史 SQL。结构化查询语言
IBM 最初称其为 SEQUEL (Structured English Query Language)
由不同类别的命令组成。
 数据操作语言（DML）。SELECT,INSERT,UPDATE,DELETE 数据定义语言（DDL）。模式定义。 数据控制语言（DCL）。安全，访问控制。  目前的 SQL 标准是 SQL:2016
各阶段引入的特性
 SQL:2016 → JSON, Polymorphic tables SQL:2011 → Temporal DBs, Pipelined DML SQL:2008 → TRUNCATE, Fancy sorting SQL:2003 → XML, windows, sequences, auto-gen IDs. SQL:1999 → Regex, triggers, OO  SQL 并没有死。它每隔几年就会有新的功能被更新。SQL-92 是一个 DBMS 必须支持的最低版本，以便声称他们支持 SQL。每个供应商都在一定程度上遵循该标准，但也有许多专有的扩展。">
<link rel=stylesheet href=/css/styles.a1d8fc2f132c452937740993f66c1b7a35d39b0774f74823f917c8b66b7795716119b0af416457217bed8e35420077308b167d77d283c319f347c34500e4ca46.css integrity="sha512-odj8LxMsRSk3dAmT9mwbejXTmwd090gj+RfItmt3lXFhGbCvQWRXIXvtjjVCAHcwixZ9d9KDwxnzR8NFAOTKRg=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=icon type=image/png href=/images/favicon.ico>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-X1L70M4MM0','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body class="max-width mx-auto px3 ltr">
<div class="content index py4">
<header id=header>
<a href=/>
<div id=logo style=background-image:url(/images/logo.png)></div>
<div id=title>
<h1>Y.CH.Y</h1>
</div>
</a>
<div id=nav>
<ul>
<li class=icon>
<a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a>
</li>
<li><a href=/>Home</a></li>
</ul>
</div>
</header>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X1L70M4MM0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-X1L70M4MM0',{anonymize_ip:!1})}</script>
<article class=post itemscope itemtype=http://schema.org/BlogPosting>
<div class=content itemprop=articleBody>
<h2 id=高级-sql>高级 SQL</h2>
<p><img src=https://i.imgur.com/flXoQVk.png alt=img></p>
<h3 id=关系语言>关系语言</h3>
<p>Edgar Codd 在 20 世纪 70 年代初发表了关于关系模型的主要论文。他最初只定义了 DBMS 如何在关系模型 DBMS 上执行查询的数学符号。</p>
<p>用户只需要使用声明性语言（即 SQL）来指定他们想要的结果。DBMS 负责通过使用查询优化器重新组合操作确定产生该答案的最有效计划。</p>
<p>关系代数是基于 <code>sets</code>（无序的，没有重复的）。SQL 是基于 <code>bags</code>（无序的，允许重复）</p>
<h3 id=sql-历史>SQL 历史</h3>
<p>SQL。结构化查询语言</p>
<p>IBM 最初称其为 <code>SEQUEL</code> (Structured English Query Language)</p>
<p>由不同类别的命令组成。</p>
<ul>
<li>数据操作语言（DML）。<code>SELECT</code>,<code>INSERT</code>,<code>UPDATE</code>,<code>DELETE</code></li>
<li>数据定义语言（DDL）。模式定义。</li>
<li>数据控制语言（DCL）。安全，访问控制。</li>
</ul>
<p>目前的 SQL 标准是 SQL:2016</p>
<p>各阶段引入的特性</p>
<ul>
<li>SQL:2016 → JSON, Polymorphic tables</li>
<li>SQL:2011 → Temporal DBs, Pipelined DML</li>
<li>SQL:2008 → TRUNCATE, Fancy sorting</li>
<li>SQL:2003 → XML, windows, sequences, auto-gen IDs.</li>
<li>SQL:1999 → Regex, triggers, OO</li>
</ul>
<p>SQL 并没有死。它每隔几年就会有新的功能被更新。SQL-92 是一个 DBMS 必须支持的最低版本，以便声称他们支持 SQL。每个供应商都在一定程度上遵循该标准，但也有许多专有的扩展。</p>
<h3 id=数据库例子>数据库例子</h3>
<p><img src=https://i.imgur.com/ADQaxYv.png alt=img></p>
<h3 id=聚合>聚合</h3>
<p>聚合函数接收一组元组作为其输入，然后产生一个单一的标量值作为其输出。只能在 SELECT 输出列表中使用。</p>
<p>举例：获取使用'@cs&rsquo;登录的学生某个信息。以下三个查询是等价的。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#00a8c8>count</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#111>)</span> <span style=color:#00a8c8>from</span> <span style=color:#111>student</span> <span style=color:#00a8c8>where</span> <span style=color:#111>login</span> <span style=color:#00a8c8>like</span> <span style=color:#d88200>&#39;%@cs&#39;</span><span style=color:#111>;</span>
<span style=color:#00a8c8>select</span> <span style=color:#00a8c8>count</span><span style=color:#111>(</span><span style=color:#111>login</span><span style=color:#111>)</span> <span style=color:#00a8c8>from</span> <span style=color:#111>student</span> <span style=color:#00a8c8>where</span> <span style=color:#111>login</span> <span style=color:#00a8c8>like</span> <span style=color:#d88200>&#39;%@cs&#39;</span><span style=color:#111>;</span>
<span style=color:#00a8c8>select</span> <span style=color:#00a8c8>count</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#00a8c8>from</span> <span style=color:#111>student</span> <span style=color:#00a8c8>where</span> <span style=color:#111>login</span> <span style=color:#00a8c8>like</span> <span style=color:#d88200>&#39;%@cs&#39;</span><span style=color:#111>;</span>
</code></pre></div><table>
<thead>
<tr>
<th>count(1)</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
</tr>
</tbody>
</table>
<p>获取用'@cs&rsquo;登录的学生数量和他们的平均 GPA。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#00a8c8>avg</span><span style=color:#111>(</span><span style=color:#111>gpa</span><span style=color:#111>),</span> <span style=color:#00a8c8>count</span><span style=color:#111>(</span><span style=color:#111>sid</span><span style=color:#111>)</span> <span style=color:#00a8c8>from</span> <span style=color:#111>student</span> <span style=color:#00a8c8>where</span> <span style=color:#111>login</span> <span style=color:#00a8c8>like</span> <span style=color:#d88200>&#39;%@cs&#39;</span><span style=color:#111>;</span>
</code></pre></div><table>
<thead>
<tr>
<th>avg(gpa)</th>
<th>count(sid)</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.25</td>
<td>12</td>
</tr>
</tbody>
</table>
<p>部分函数支持<code>DISTINCT</code>关键字</p>
<p><code>COUNT</code>, <code>SUM</code>, <code>AVG</code> 支持 <code>DISTINCT</code></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#00a8c8>count</span><span style=color:#111>(</span><span style=color:#00a8c8>distinct</span> <span style=color:#111>login</span><span style=color:#111>)</span> <span style=color:#00a8c8>from</span> <span style=color:#111>student</span> <span style=color:#00a8c8>where</span> <span style=color:#111>login</span> <span style=color:#00a8c8>like</span> <span style=color:#d88200>&#39;%@cs&#39;</span><span style=color:#111>;</span>
</code></pre></div><table>
<thead>
<tr>
<th>COUNT(DISTINCT login)</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
</tr>
</tbody>
</table>
<p>聚合列之外的其他列的输出是未定义的（e.cid 在下面未定义）。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#00a8c8>avg</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>.</span><span style=color:#111>gpa</span><span style=color:#111>),</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>cid</span> <span style=color:#00a8c8>from</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>as</span> <span style=color:#111>e</span><span style=color:#111>,</span> <span style=color:#111>student</span> <span style=color:#00a8c8>as</span> <span style=color:#111>s</span> <span style=color:#00a8c8>where</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>sid</span> <span style=color:#f92672>=</span> <span style=color:#111>s</span><span style=color:#111>.</span><span style=color:#111>sid</span><span style=color:#111>;</span>
</code></pre></div><table>
<thead>
<tr>
<th>AVG(s.gpa)</th>
<th>e.cid</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.5</td>
<td>???</td>
</tr>
</tbody>
</table>
<p>因此，聚合列之外的其他列必须被聚合或用于 GROUP BY 命令中。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#00a8c8>avg</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>.</span><span style=color:#111>gpa</span><span style=color:#111>),</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>cid</span> <span style=color:#00a8c8>from</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>as</span> <span style=color:#111>e</span><span style=color:#111>,</span> <span style=color:#111>student</span> <span style=color:#00a8c8>as</span> <span style=color:#111>s</span> <span style=color:#00a8c8>where</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>sid</span> <span style=color:#f92672>=</span> <span style=color:#111>s</span><span style=color:#111>.</span><span style=color:#111>sid</span> <span style=color:#00a8c8>group</span> <span style=color:#00a8c8>by</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>cid</span><span style=color:#111>;</span>
</code></pre></div><p><code>HAVING</code>：过滤聚合后的输出结果。就像一个<code>GROUP BY</code>的<code>WHERE</code>子句</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#00a8c8>AVG</span><span style=color:#111>(</span><span style=color:#111>s</span><span style=color:#111>.</span><span style=color:#111>gpa</span><span style=color:#111>)</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>avg_gpa</span><span style=color:#111>,</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>cid</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>e</span><span style=color:#111>,</span> <span style=color:#111>student</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>s</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>sid</span> <span style=color:#f92672>=</span> <span style=color:#111>s</span><span style=color:#111>.</span><span style=color:#111>sid</span> <span style=color:#00a8c8>GROUP</span> <span style=color:#00a8c8>BY</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>cid</span> <span style=color:#00a8c8>HAVING</span> <span style=color:#111>avg_gpa</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>3</span><span style=color:#111>.</span><span style=color:#ae81ff>9</span><span style=color:#111>;</span>
</code></pre></div><h3 id=字符串操作>字符串操作</h3>
<p>SQL 标准规定，字符串区分大小写，而且只能是单引号</p>
<p>事实上</p>
<table>
<thead>
<tr>
<th>SQL-92</th>
<th>Sensitive</th>
<th>Single Only</th>
</tr>
</thead>
<tbody>
<tr>
<td>Postgres</td>
<td>Sensitive</td>
<td>Single Only</td>
</tr>
<tr>
<td>MySQL</td>
<td>Insensitive</td>
<td>Single/Double</td>
</tr>
<tr>
<td>SQLite</td>
<td>Sensitive</td>
<td>Single/Double</td>
</tr>
<tr>
<td>DB2</td>
<td>Sensitive</td>
<td>Single Only</td>
</tr>
<tr>
<td>Oracle</td>
<td>Sensitive</td>
<td>Single Only</td>
</tr>
</tbody>
</table>
<p>有一些函数可以处理字符串，可以在查询的任何部分使用</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#00a8c8>substring</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>,</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#ae81ff>5</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>abbrv_name</span> <span style=color:#00a8c8>from</span> <span style=color:#111>student</span> <span style=color:#00a8c8>where</span> <span style=color:#111>sid</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>53688</span>
<span style=color:#00a8c8>select</span> <span style=color:#f92672>*</span> <span style=color:#00a8c8>from</span> <span style=color:#111>student</span> <span style=color:#00a8c8>as</span> <span style=color:#111>s</span> <span style=color:#00a8c8>where</span> <span style=color:#00a8c8>upper</span><span style=color:#111>(</span><span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>name</span><span style=color:#111>)</span> <span style=color:#00a8c8>like</span> <span style=color:#d88200>&#39;kan%&#39;</span>
</code></pre></div><ul>
<li>substring</li>
<li>upper</li>
<li>lower</li>
<li>concat</li>
</ul>
<p>模式匹配</p>
<p>LIKE 关键字用于谓词中的字符串匹配</p>
<ul>
<li>&ldquo;%&rdquo; 匹配任何子字符串（包括空）</li>
<li>&ldquo;_&rdquo; 匹配任何一个字符</li>
</ul>
<p>串联</p>
<p>两个竖条（"||"）将两个或多个字符串连接成一个单一的字符串</p>
<p><code>SQL-92</code></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>name</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>login</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>LOWER</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>)</span> <span style=color:#f92672>||</span> <span style=color:#d88200>&#39;@cs&#39;</span>
</code></pre></div><p><code>MSSQL</code></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>name</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>login</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>LOWER</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>)</span> <span style=color:#f92672>+</span> <span style=color:#d88200>&#39;@cs&#39;</span>
</code></pre></div><p><code>MySQL</code></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>name</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>login</span> <span style=color:#f92672>=</span> <span style=color:#111>CONCAT</span><span style=color:#111>(</span><span style=color:#00a8c8>LOWER</span><span style=color:#111>(</span><span style=color:#111>name</span><span style=color:#111>),</span> <span style=color:#d88200>&#39;@cs&#39;</span><span style=color:#111>)</span>
</code></pre></div><h3 id=时间日期操作>时间日期操作</h3>
<p>处理和修改日期/时间属性</p>
<p>可以在输出和谓词中使用</p>
<p>支持/语法有很大的不同</p>
<p>例子:获取一年中的第几天</p>
<p><code>pgsql</code></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#111>date</span><span style=color:#111>(</span><span style=color:#d88200>&#39;2019-08-23&#39;</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#111>date</span><span style=color:#111>(</span><span style=color:#d88200>&#39;2019-01-01&#39;</span><span style=color:#111>)</span> <span style=color:#00a8c8>as</span> <span style=color:#111>days</span><span style=color:#111>;</span>
</code></pre></div><p><code>mysql</code></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>select</span> <span style=color:#111>datediff</span><span style=color:#111>(</span><span style=color:#111>date</span><span style=color:#111>(</span><span style=color:#d88200>&#39;2019-08-23&#39;</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#111>date</span><span style=color:#111>(</span><span style=color:#d88200>&#39;2019-01-01&#39;</span><span style=color:#111>))</span> <span style=color:#00a8c8>as</span> <span style=color:#111>days</span>
</code></pre></div><p><code>sqlite</code></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>not</span> <span style=color:#111>supprt</span>
</code></pre></div><h3 id=输出重定向>输出重定向</h3>
<p>把查询结果存入另一张表</p>
<p>新表:将查询的输出存储到一个新的表中。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#00a8c8>DISTINCT</span> <span style=color:#111>cid</span> <span style=color:#00a8c8>INTO</span> <span style=color:#111>CourseIds</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span><span style=color:#111>;</span>
</code></pre></div><p>现有的表:将查询的输出存储到数据库中已经存在的表中。该表目标表必须有与目标表相同数量和相同类型的列，但输出查询中的列名不需要匹配。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>INSERT</span> <span style=color:#00a8c8>INTO</span> <span style=color:#111>CourseIds</span> <span style=color:#111>(</span><span style=color:#00a8c8>SELECT</span> <span style=color:#00a8c8>DISTINCT</span> <span style=color:#111>cid</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span><span style=color:#111>);</span>
</code></pre></div><h3 id=输出控制>输出控制</h3>
<p><code>ORDER BY</code></p>
<p>由于 SQL 的结果是无序的，你必须使用<code>ORDER BY</code>子句来对元组进行排序。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>sid</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>cid</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;15-721&#39;</span> <span style=color:#00a8c8>ORDER</span> <span style=color:#00a8c8>BY</span> <span style=color:#111>grade</span> <span style=color:#00a8c8>DESC</span><span style=color:#111>;</span>
</code></pre></div><p>你可以使用多个<code>ORDER BY</code>子句来更复杂的排序。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>sid</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>cid</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;15-721&#39;</span> <span style=color:#00a8c8>ORDER</span> <span style=color:#00a8c8>BY</span> <span style=color:#111>grade</span> <span style=color:#00a8c8>DESC</span><span style=color:#111>,</span> <span style=color:#111>sid</span> <span style=color:#00a8c8>ASC</span><span style=color:#111>;</span>
</code></pre></div><p>你也可以在<code>ORDER BY</code>子句中使用任何任意的表达式。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>sid</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>cid</span> <span style=color:#f92672>=</span> <span style=color:#d88200>&#39;15-721&#39;</span> <span style=color:#00a8c8>ORDER</span> <span style=color:#00a8c8>BY</span> <span style=color:#00a8c8>UPPER</span><span style=color:#111>(</span><span style=color:#111>grade</span><span style=color:#111>)</span> <span style=color:#00a8c8>DESC</span><span style=color:#111>,</span> <span style=color:#111>sid</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#00a8c8>ASC</span><span style=color:#111>;</span>
</code></pre></div><p><code>LIMIT</code></p>
<p>默认情况下，DBMS 将返回由查询产生的所有元组。你可以使用 <code>LIMIT</code> 子句来限制结果元组的数量</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>sid</span><span style=color:#111>,</span> <span style=color:#111>name</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>login</span> <span style=color:#00a8c8>LIKE</span> <span style=color:#d88200>&#39;%@cs&#39;</span> <span style=color:#00a8c8>LIMIT</span> <span style=color:#ae81ff>10</span><span style=color:#111>;</span>
</code></pre></div><p>也可以提供一个偏移量来返回结果中的一个范围</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>sid</span><span style=color:#111>,</span> <span style=color:#111>name</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>login</span> <span style=color:#00a8c8>LIKE</span> <span style=color:#d88200>&#39;%@cs&#39;</span> <span style=color:#00a8c8>LIMIT</span> <span style=color:#ae81ff>10</span> <span style=color:#00a8c8>OFFSET</span> <span style=color:#ae81ff>20</span><span style=color:#111>;</span>
</code></pre></div><p>除非你使用带有<code>LIMIT</code>的<code>ORDER BY</code>子句，否则每次调用的结果中的元组可能是不同的。</p>
<h3 id=嵌套查询>嵌套查询</h3>
<p>在其他查询中调用查询，以在单个查询中执行更复杂的逻辑。外部查询的范围包括在内部查询中（即内部查询可以访问外部查询的属性），但不能反过来。</p>
<p>内部查询几乎可以出现在查询的任何地方</p>
<p>从输出结果</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>(</span><span style=color:#00a8c8>SELECT</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>one</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span><span style=color:#111>;</span>
</code></pre></div><p>从子句</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>name</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>s</span><span style=color:#111>,</span> <span style=color:#111>(</span><span style=color:#00a8c8>SELECT</span> <span style=color:#111>sid</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span><span style=color:#111>)</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>e</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>s</span><span style=color:#111>.</span><span style=color:#111>sid</span> <span style=color:#f92672>=</span> <span style=color:#111>e</span><span style=color:#111>.</span><span style=color:#111>sid</span><span style=color:#111>;</span>
</code></pre></div><p>从 WHERE 子句</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>name</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>student</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>sid</span> <span style=color:#00a8c8>IN</span> <span style=color:#111>(</span> <span style=color:#00a8c8>SELECT</span> <span style=color:#111>sid</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span> <span style=color:#111>);</span>
</code></pre></div><p>嵌套查询结果表达式</p>
<ul>
<li>ALL: 必须满足子查询中所有记录的表达式。</li>
<li>ANY: 必须满足子查询中至少一条记录的表达式。</li>
<li>IN: 相当于 ANY()</li>
<li>EXISTS: 至少有一条记录被返回。</li>
</ul>
<h3 id=窗口函数>窗口函数</h3>
<p>在一组元组中执行 &ldquo;移动 &ldquo;计算。像聚合操作，但它仍然返回原始元组</p>
<p><code>Functions</code> 可以是我们上面讨论的任何一个聚合函数。也可以是一个特殊的窗口函数。</p>
<ul>
<li>ROW NUMBER：当前行的编号。</li>
<li>RANK：当前行的顺序位置。</li>
</ul>
<p><code>Grouping</code> The <code>OVER</code> clause specifies how to group together tuples when computing the window function. Use <code>PARTITION BY</code> to specify group.</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#111>cid</span><span style=color:#111>,</span> <span style=color:#111>sid</span><span style=color:#111>,</span> <span style=color:#111>ROW_NUMBER</span><span style=color:#111>()</span> <span style=color:#111>OVER</span> <span style=color:#111>(</span><span style=color:#111>PARTITION</span> <span style=color:#00a8c8>BY</span> <span style=color:#111>cid</span><span style=color:#111>)</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>ORDER</span> <span style=color:#00a8c8>BY</span> <span style=color:#111>cid</span><span style=color:#111>;</span>
</code></pre></div><p>你也可以在<code>OVER</code>中放一个<code>ORDER BY</code>，以确保即使数据库内部发生变化，结果的排序也是确定不变的。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>SELECT</span> <span style=color:#f92672>*</span><span style=color:#111>,</span> <span style=color:#111>ROW_NUMBER</span><span style=color:#111>()</span> <span style=color:#111>OVER</span> <span style=color:#111>(</span><span style=color:#00a8c8>ORDER</span> <span style=color:#00a8c8>BY</span> <span style=color:#111>cid</span><span style=color:#111>)</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>enrolled</span> <span style=color:#00a8c8>ORDER</span> <span style=color:#00a8c8>BY</span> <span style=color:#111>cid</span><span style=color:#111>;</span>
</code></pre></div><p>重要提示：DBMS 在窗口函数排序后计算 <code>RANK</code>，而在排序前计算 <code>ROW_NUMBER</code></p>
<h3 id=公共表表达式>公共表表达式</h3>
<p>公共表表达式（CTE）是窗口或嵌套查询的一种替代方法，可以用来编写更复杂的查询。我们可以把 CTE 看作是一个临时表，只用于一个查询。</p>
<p><code>WITH</code> 子句将内部查询的输出与具有该名称的临时结果结合起来。生成一个名为 &ldquo;cteName"的 CTE，它包含一个单一属性设置为 &ldquo;1&rdquo; 的元组。然后底部的查询只是返回 &ldquo;cteName &ldquo;的所有属性。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>WITH</span> <span style=color:#111>cteName</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>(</span><span style=color:#00a8c8>SELECT</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#00a8c8>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>cteName</span><span style=color:#111>;</span>
</code></pre></div><p>你可以在 AS 之前将输出列与名称绑定。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>WITH</span> <span style=color:#111>cteName</span> <span style=color:#111>(</span><span style=color:#111>col1</span><span style=color:#111>,</span> <span style=color:#111>col2</span><span style=color:#111>)</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>(</span><span style=color:#00a8c8>SELECT</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span> <span style=color:#00a8c8>SELECT</span> <span style=color:#111>col1</span> <span style=color:#f92672>+</span> <span style=color:#111>col2</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>cteName</span><span style=color:#111>;</span>
</code></pre></div><p>一个查询可以包含多个 CTE 声明。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>WITH</span> <span style=color:#111>cte1</span> <span style=color:#111>(</span><span style=color:#111>col1</span><span style=color:#111>)</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>(</span> <span style=color:#00a8c8>SELECT</span> <span style=color:#ae81ff>1</span><span style=color:#111>),</span> <span style=color:#111>cte2</span> <span style=color:#111>(</span><span style=color:#111>col2</span><span style=color:#111>)</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>(</span> <span style=color:#00a8c8>SELECT</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span> <span style=color:#00a8c8>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>cte1</span><span style=color:#111>,</span> <span style=color:#111>cte2</span><span style=color:#111>;</span>
</code></pre></div><p>在<code>WITH</code>后面添加<code>RECURSIVE</code>关键字允许 CTE 引用自己。</p>
<p>例子。打印从 1 到 10 的数字序列。</p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#00a8c8>WITH</span> <span style=color:#00a8c8>RECURSIVE</span> <span style=color:#111>cteSource</span> <span style=color:#111>(</span><span style=color:#111>counter</span><span style=color:#111>)</span> <span style=color:#00a8c8>AS</span> <span style=color:#111>((</span><span style=color:#00a8c8>SELECT</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#00a8c8>UNION</span> <span style=color:#111>(</span><span style=color:#00a8c8>SELECT</span> <span style=color:#111>counter</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>cteSource</span> <span style=color:#00a8c8>WHERE</span> <span style=color:#111>counter</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>))</span> <span style=color:#00a8c8>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#00a8c8>FROM</span> <span style=color:#111>cteSource</span><span style=color:#111>;</span>
</code></pre></div>
</div>
</article>
<footer id=footer>
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<div class=footer-left>
Copyright &copy; 2021 Y.CH.Y
<span id=busuanzi_container_page_pv>Page PV : <span id=busuanzi_value_page_pv></span></span>
<span id=busuanzi_container_site_uv>Site UV : <span id=busuanzi_value_site_uv></span></span>
</div>
<div class=footer-right>
<nav>
<ul>
<li><a href=/>Home</a></li>
</ul>
</nav>
</div>
</footer>
</div>
</body>
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>